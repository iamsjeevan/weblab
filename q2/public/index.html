<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Q2 Part B: Student Details Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        form, .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="number"] { width: calc(100% - 12px); padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 3px; }
        button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px; }
        button:hover { background-color: #1e7e34; }
        button.delete { background-color: #dc3545; }
        button.delete:hover { background-color: #c82333; }
        ul { list-style-type: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #eee; }
        li:last-child { border-bottom: none; }
        .student-item span { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Student Details Management</h1>

        <form id="addStudentForm">
            <h2>Add New Student</h2>
            <label for="student_name">Student Name:</label>
            <input type="text" id="student_name" name="student_name" required>
            <label for="usn">USN:</label>
            <input type="text" id="usn" name="usn" required>
            <label for="semester">Semester:</label>
            <input type="number" id="semester" name="semester" required>
            <label for="exam_fee">Exam Fee (leave empty or 0 if not paid):</label>
            <input type="number" id="exam_fee" name="exam_fee" step="any" placeholder="e.g., 1500 or 0">
            <button type="submit">Add Student</button>
        </form>

        <div class="section">
            <h2>Actions</h2>
            <button class="delete" onclick="deleteUnpaidStudents()">Delete Students with Unpaid Exam Fee</button>
        </div>

        <div class="section">
            <h2>Student List</h2>
            <button onclick="fetchStudents()">Refresh List</button>
            <ul id="studentsList"></ul>
        </div>
    </div>

    <script>
        const addStudentForm = document.getElementById('addStudentForm');
        const studentsList = document.getElementById('studentsList');

        addStudentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(addStudentForm);
            const studentData = {};
            // FormData does not distinguish well between empty string and 0 for numbers if type="number"
            // So we handle exam_fee explicitly.
            formData.forEach((value, key) => {
                studentData[key] = value;
            });
             if (studentData.exam_fee === '') { // If empty, server will treat as null
                studentData.exam_fee = ''; // Send as empty string
            } else {
                studentData.exam_fee = parseFloat(studentData.exam_fee);
            }


            try {
                const response = await fetch('/students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });
                if (!response.ok) throw new Error('Failed to add student: ' + await response.text());
                addStudentForm.reset();
                fetchStudents(); // Refresh list
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        });

        async function deleteUnpaidStudents() {
            if (!confirm('Are you sure you want to delete all students with unpaid (0 or null) exam fees?')) {
                return;
            }
            try {
                const response = await fetch('/students/unpaid', { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete unpaid students: ' + await response.text());
                const result = await response.json();
                alert(result.message);
                fetchStudents(); // Refresh list
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }
        
        async function fetchStudents() {
            try {
                const response = await fetch('/students');
                if (!response.ok) throw new Error('Failed to fetch students: ' + await response.text());
                const students = await response.json();
                
                studentsList.innerHTML = '';
                if (students.length === 0) {
                    studentsList.innerHTML = '<li>No students found.</li>';
                    return;
                }
                students.forEach(s => {
                    const li = document.createElement('li');
                    li.className = 'student-item';
                    li.innerHTML = `
                        <span><strong>Name:</strong> ${s.student_name}</span>
                        <span><strong>USN:</strong> ${s.usn}</span>
                        <span><strong>Semester:</strong> ${s.semester}</span>
                        <span><strong>Exam Fee:</strong> ${s.exam_fee === null ? 'N/A' : s.exam_fee}</span>
                        <span><em>(MongoID: ${s._id})</em></span>
                    `;
                    studentsList.appendChild(li);
                });
            } catch (error) {
                console.error(error);
                studentsList.innerHTML = `<li>Error loading students: ${error.message}</li>`;
            }
        }

        // Initial fetch
        fetchStudents();
    </script>
</body>
</html>
